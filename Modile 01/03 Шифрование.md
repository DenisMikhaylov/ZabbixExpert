
# Лабораторнная : Настройка шифрованного подключения

### Сценарий

Необходимо настроить защищенное подключение для агента zabbix и сервера Zabbix используя подходящую технологию шифрования.

### Цели

После завершения этой лабораторной работы вы настроите шифрованное подключение использую psk.

### Настройка лабораторной

Виртуальные машины: Zabbix, Debian-1

Пользователь: **root**

Пароль:  **Pa$$w0rd**

**Настройка Лабораторной**

Для этой лабораторной работы вы будете использовать доступную среду виртуальной машины. Прежде чем приступить к лабораторной работе, необходимо выполнить следующие шаги:

1. На главном компьютере запустите **Диспетчер Hyper-V**.

2. В **Диспетчере Hyper-V** выберите **Zabbix**, а затем на панели **Действия** выберите **Запустить**.

3. Запустите приложение Putty. В сохраненых подключения выберите **Zabbix** и выберите **открыть**

4. Войдите в систему, используя следующие учетные данные:

 - Имя пользователя: **root**

 - Пароль: **Pa$$w0rd**

5. Повторите шаги 2–4 для **Debian-1**.

6. Для доступа в интернет, запустите  **Gate**.


## Задание 1: Настройка шифрованного подключения 

#### Шаг 1: Установка агента на Debian-1

Подключаемся к Debian-1 подключаемся через putty, войдите в систему как **root** с паролем **Pa$$w0rd**.

Процедура установки последней версии агента на сайте Zabbix 

```
https://www.zabbix.com/download?
```
1. Выбираем параметры:

```
  Zabbix Package
  Zabbix version: 6.4
  OS Distribution: Debian
  OS Version: 12
  Zabbix Component: Agent
```
3. Выполняем шаги описание с пункта 2 на сайте.

   Добавлем репозиторий
   Устанавиваем агента

#### Шаг 2: Создание PSK файла


1. Сгенерируем на Debian-1 psk фразу командой и записываем ее в файл

```
openssl rand -hex 32 > /etc/zabbix/zabbix_agent.psk
```
2. Выводим этот ключ на экран командой 

```
tail /etc/zabbix/zabbix_agent.psk
```
Сохраняем у себя данный ключ в блокноте

#### Шаг 3: Настройка файла конфигурации агента Zabbix

1. Настройка файла конфигурации на Debian-1

```
nano /etc/zabbix/zabbix_agentd.conf
```
```
Меняем следующие значения:
Server=    192.168.10.41
Hostname=  Debian-1
TLSAccept=psk
TLSConnect=psk
TLSPSKFile=/etc/zabbix/zabbix_agent.psk
TLSPSKIdentity=Debian-1
```
2. Перезагрузка агента
   
```
systemctl restart zabbix-agent
systemctl enable zabbix-agent
```

#### Шаг 3: Подключаемся агента в  Zabbix

1. На главном компьютере запускем Chrome и в браузере вводим **http://zabbix.corp1.ru**

2. На странице привествия вводим логин **Admin** и пароль **zabbix**

3. Переходим на быстром меню на вкладку **Data colletion** - **Hosts**

4. Выбираем **Create Host**

5. Заполняем поля формы
   ```
   Host name: Debian-1
   Host Group: my
   interfaces: agent
   ip address: 192.168.10.103
   Connect to: ip
   Port: 10050
   ```
6. Выбираем **Encryption**
   ```
   Connections to host: psk
   Connections from host: psk
   Psk identity: Debian-1
   PSK: Ключ сохраненый из блокнота
   ```
7. Выбираем Add

8. Ждем обновления информации о подключение агента.

 >  **Result**: После выполнения данного задания, вы должны были успешно добавить своего агента в Zabbix с шифрованным подключением.
9. Проверка

 

Скопировать файл psk на zabbix server c agenta

```
scp /etc/zabbix/zabbix_agent.psk <ip zabbix>:/etc/zabbix
```

Перейти на zabbix сервер.
```
zabbix_get -s <ip agent> -k "system.cpu.load[all,avg1]" --tls-connect=psk --tls-psk-identity="<identitty PSK>" --tls-psk-file=/etc/zabbix/zabbix_agentd.psk
```
